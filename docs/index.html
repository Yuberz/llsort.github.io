<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Love Live Character Sorter</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            :root {
                --primary: #ff66aa;
                --secondary: #f0f0f8;
                --accent: #99ccff;
                --text: #333333;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background: linear-gradient(135deg, #ffeff5, #e6f0ff);
                color: var(--text);
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
                min-height: 100vh;
                position: relative;
                padding-bottom: 60px;
            }

            header {
                text-align: center;
                margin: 20px 0 30px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            h1 {
                color: var(--primary);
                font-size: 2.8rem;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            }

            .subtitle {
                color: #666;
                font-size: 1.2rem;
                margin-top: -5px;
            }

            .panel {
                background-color: white;
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
                padding: 25px;
                margin-bottom: 25px;
                transition: transform 0.3s ease;
            }

            .panel:hover {
                transform: translateY(-5px);
            }

            .panel h2 {
                margin-bottom: 20px;
                color: var(--primary);
                font-size: 1.6rem;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .panel h2::before {
                content: "â˜…";
                color: #ffcc00;
            }

            .group-container {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                margin-top: 15px;
            }

            .group-item {
                display: flex;
                align-items: center;
                gap: 8px;
                background: #f8f8ff;
                padding: 8px 15px;
                border-radius: 30px;
                border: 1px solid #e0e0ff;
            }

            .matchup-container {
                display: flex;
                justify-content: center;
                gap: 60px;
                margin: 30px 0;
                flex-wrap: wrap;
            }

            .character-btn {
                background: linear-gradient(145deg, #ffffff, #f0f0ff);
                border: 3px solid var(--accent);
                border-radius: 15px;
                padding: 25px;
                width: 320px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                box-shadow: 0 8px 20px rgba(0, 0, 100, 0.1);
            }

            .character-btn:hover {
                transform: translateY(-8px);
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
                border-color: var(--primary);
            }

            .character-img {
                width: 220px;
                height: 220px;
                object-fit: cover;
                border-radius: 15px;
                margin-bottom: 15px;
                background: linear-gradient(45deg, #ffddee, #ddeeff);
                border: 3px solid white;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }

            .character-name {
                font-weight: bold;
                font-size: 1.4rem;
                margin-bottom: 5px;
                color: #5533aa;
            }

            .character-info {
                font-size: 1rem;
                color: #666;
                background: #f9f9ff;
                padding: 5px 15px;
                border-radius: 20px;
                margin-top: 5px;
            }

            .progress-container {
                text-align: center;
                margin: 25px 0;
                font-size: 1.2rem;
                background: rgba(255, 255, 255, 0.7);
                padding: 15px;
                border-radius: 12px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            }

            .btn-container {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin: 25px 0;
            }

            button {
                background: linear-gradient(to right, var(--primary), #ff5599);
                color: white;
                border: none;
                border-radius: 50px;
                padding: 12px 30px;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 5px 15px rgba(255, 102, 170, 0.3);
                font-weight: bold;
                letter-spacing: 0.5px;
            }

            button:disabled {
                background: linear-gradient(to right, #cccccc, #aaaaaa);
                cursor: not-allowed;
                box-shadow: none;
            }

            button:hover:not(:disabled) {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(255, 102, 170, 0.4);
            }

            .results-container {
                display: none;
                animation: fadeIn 0.5s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .tab-container {
                margin-bottom: 30px;
            }

            .tab-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 25px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .tab-btn {
                background: linear-gradient(to right, #dddddd, #cccccc);
                color: #555;
                border: none;
                border-radius: 50px;
                padding: 10px 25px;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s;
            }

            .tab-btn.active {
                background: linear-gradient(to right, var(--primary), #ff5599);
                color: white;
                box-shadow: 0 5px 15px rgba(255, 102, 170, 0.3);
            }

            .tab-content {
                display: none;
                animation: fadeIn 0.4s ease;
            }

            .tab-content.active {
                display: block;
            }

            .chart-container {
                height: 450px;
                margin: 30px 0;
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin: 25px 0;
                background: white;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            }

            th,
            td {
                padding: 15px;
                text-align: left;
                border-bottom: 1px solid #eee;
            }

            th {
                background: linear-gradient(to right, var(--accent), #88bbff);
                color: white;
                font-weight: bold;
            }

            tr:nth-child(even) {
                background-color: #f9f9ff;
            }

            tr:hover {
                background-color: #f0f5ff;
            }

            .back-btn {
                background: linear-gradient(to right, #666666, #555555);
            }

            .back-btn:hover {
                background: linear-gradient(to right, #555555, #444444);
            }

            .setting-item {
                margin: 15px 0;
                display: flex;
                align-items: center;
                gap: 15px;
                background: #f9f9ff;
                padding: 15px;
                border-radius: 12px;
            }

            @media (max-width: 768px) {
                .matchup-container {
                    flex-direction: column;
                    align-items: center;
                    gap: 30px;
                }

                .character-btn {
                    width: 100%;
                    max-width: 320px;
                }

                .tab-buttons {
                    flex-direction: column;
                    align-items: center;
                }

                .btn-container {
                    flex-direction: column;
                    align-items: center;
                }
            }

            .creator-credit {
                position: fixed;
                bottom: 15px;
                left: 15px;
                font-size: 0.9rem;
                color: #666;
                z-index: 100;
                background: rgba(255, 255, 255, 0.8);
                padding: 8px 15px;
                border-radius: 20px;
                backdrop-filter: blur(5px);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            }

            .creator-credit a {
                color: var(--primary);
                text-decoration: none;
                transition: all 0.3s;
                font-weight: 600;
            }

            .creator-credit a:hover {
                color: #ff3388;
                text-decoration: underline;
            }

            .logo {
                display: flex;
                justify-content: center;
                margin-bottom: 10px;
            }

            .logo-icon {
                font-size: 3rem;
                color: var(--primary);
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            }

            .instructions {
                text-align: center;
                margin: 15px 0 25px;
                color: #666;
                font-size: 1.1rem;
                max-width: 1200px;
                margin-left: auto;
                margin-right: auto;
                line-height: 1.6;
            }

            .comparison-stats {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 10px;
            }

            .stat-box {
                background: rgba(255, 255, 255, 0.7);
                padding: 10px 20px;
                border-radius: 10px;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            }

            /* NEW STYLES FOR HEIGHT ANALYSIS */
            .height-bar-container {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin: 20px 0;
                padding: 15px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            }

            .height-bar {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 10px;
                border-radius: 8px;
                background: #f8f8ff;
                transition: transform 0.3s ease;
            }

            .height-bar:hover {
                transform: translateX(5px);
                background: #f0f5ff;
            }

            .character-info-container {
                min-width: 220px;
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .character-thumb {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid white;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            }

            .character-name-info {
                flex-grow: 1;
            }

            .character-name-bar {
                font-weight: bold;
                font-size: 1.1rem;
                color: #5533aa;
            }

            .character-details {
                font-size: 0.9rem;
                color: #666;
            }

            .bar-container {
                flex-grow: 1;
                height: 40px;
                background: #e0e0ff;
                border-radius: 20px;
                overflow: hidden;
                position: relative;
                min-width: 200px;
            }

            .bar-fill {
                height: 100%;
                background: linear-gradient(to right, #99ccff, #ff99cc);
                border-radius: 20px;
                min-width: 10px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding-right: 10px;
                transition: width 1s ease;
            }

            .bar-value {
                color: white;
                font-weight: bold;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            }

            .height-info {
                min-width: 120px;
                text-align: center;
                font-weight: bold;
                color: #333;
            }

            .height-label {
                font-size: 1.1rem;
            }

            .height-cm {
                font-size: 0.9rem;
                color: #666;
            }

            .stats-summary {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
                gap: 20px;
                margin: 20px 0;
                padding: 20px;
                background: rgba(255, 255, 255, 0.7);
                border-radius: 12px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            }

            .stat-card {
                background: white;
                border-radius: 10px;
                padding: 15px;
                text-align: center;
                min-width: 180px;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            }

            .stat-value {
                font-size: 1.8rem;
                font-weight: bold;
                color: var(--primary);
                margin: 10px 0;
            }

            .stat-label {
                font-size: 1rem;
                color: #666;
            }

            .preference-indicator {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                margin-top: 10px;
                padding: 10px;
                border-radius: 20px;
                background: #ffeff5;
                font-weight: bold;
            }

            .preference-icon {
                font-size: 1.5rem;
            }

            .scroll-container {
                overflow-x: auto;
                padding: 10px 5px;
            }

            /* Export/Import Styles */
            .export-import-container {
                display: flex;
                justify-content: center;
                gap: 15px;
                margin: 15px 0;
            }

            .export-btn {
                background: linear-gradient(to right, #66aa66, #559955);
            }

            .import-btn {
                background: linear-gradient(to right, #6666aa, #555599);
            }

            .export-import-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                justify-content: center;
                align-items: center;
            }

            .export-import-content {
                background-color: white;
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            }

            .export-import-content h3 {
                margin-bottom: 15px;
                color: var(--primary);
                text-align: center;
            }

            .export-import-textarea {
                width: 100%;
                min-height: 150px;
                padding: 15px;
                border: 2px solid #e0e0ff;
                border-radius: 10px;
                font-family: monospace;
                resize: vertical;
                margin-bottom: 15px;
            }

            .export-import-buttons {
                display: flex;
                justify-content: center;
                gap: 10px;
            }

            .copy-btn {
                background: linear-gradient(to right, #66aaff, #5599ff);
            }

            .close-btn {
                background: linear-gradient(to right, #ff6666, #ff5555);
            }

            .notification {
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 15px 25px;
                background: linear-gradient(to right, #66aa66, #559955);
                color: white;
                border-radius: 50px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                z-index: 1001;
                animation:
                    slideIn 0.3s ease,
                    fadeOut 0.5s ease 2.5s forwards;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes fadeOut {
                from {
                    opacity: 1;
                }
                to {
                    opacity: 0;
                }
            }
        </style>
    </head>
    <body>
        <div class="logo">
            <div class="logo-icon">â™«</div>
        </div>

        <header>
            <h1>Love Live Character Sorter</h1>
            <div class="subtitle">Discover your favorite school idols!</div>
        </header>

        <div class="main-container">
            <div class="panel">
                <h2>Group Selection</h2>
                <div class="btn-container">
                    <button id="selectAllBtn">Select All</button>
                    <button id="selectNoneBtn">Select None</button>
                </div>
                <div id="groupContainer" class="group-container"></div>
            </div>

            <div class="panel">
                <h2>Settings</h2>
                <div class="setting-item">
                    <input type="checkbox" id="quickMode" />
                    <label for="quickMode"
                        >Quick Mode (use transitive relationships to reduce
                        comparisons)</label
                    >
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="showGroupYear" />
                    <label for="showGroupYear">Show Group and Year</label>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="showBloodHeight" />
                    <label for="showBloodHeight"
                        >Show Blood Type and Height</label
                    >
                </div>
            </div>

            <div class="instructions">
                Select your favorite character in each matchup. The more
                matchups you complete, the more accurate your ranking will be!
            </div>

            <div class="progress-container">
                <div id="progressText">Select at least 1 group to sort!</div>
                <div class="comparison-stats">
                    <div class="stat-box">
                        Rounds Completed: <span id="completedMatchups">0</span>
                    </div>
                    <div
                        class="stat-box"
                        id="skippedContainer"
                        style="display: none"
                    >
                        Skipped: <span id="skippedMatchups">0</span>
                    </div>
                </div>
                <div
                    id="progressBarContainer"
                    style="margin-top: 10px; display: none"
                >
                    <div
                        style="
                            width: 100%;
                            background-color: #f0f0f0;
                            border-radius: 5px;
                        "
                    >
                        <div
                            id="progressBar"
                            style="
                                height: 10px;
                                width: 0%;
                                background-color: #ff66aa;
                                border-radius: 5px;
                                transition: width 0.3s;
                            "
                        ></div>
                    </div>
                </div>
            </div>

            <div class="matchup-container" id="matchupContainer">
                <!-- Character buttons will be added here dynamically -->
            </div>

            <div class="btn-container">
                <button id="undoBtn" disabled>Undo Last</button>
                <button id="resultsBtn" disabled>View Results</button>
            </div>

            <!-- Import button in main interface -->
            <div class="export-import-container">
                <button class="import-btn" id="importMainBtn">
                    Import Results
                </button>
            </div>
        </div>

        <div class="results-container" id="resultsContainer">
            <div class="btn-container">
                <button class="back-btn" id="backBtn">â†¶ Back to Sorter</button>
            </div>

            <!-- Export/Import buttons in results -->
            <div class="export-import-container">
                <button class="export-btn" id="exportBtn">
                    Export Results
                </button>
                <button class="import-btn" id="importBtn">
                    Import Results
                </button>
            </div>

            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="rankings">
                        Rankings
                    </button>
                    <button class="tab-btn" data-tab="year">Year Stats</button>
                    <button class="tab-btn" data-tab="group">
                        Group Rankings
                    </button>
                    <button class="tab-btn" data-tab="blood">Blood Type</button>
                    <button class="tab-btn" data-tab="height">
                        Height Analysis
                    </button>
                </div>

                <div id="rankingsTab" class="tab-content active">
                    <h2>Character Rankings</h2>
                    <table id="rankingsTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Character</th>
                                <th>Wins</th>
                                <th>Year</th>
                                <th>Group</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="yearTab" class="tab-content">
                    <h2>Year Statistics</h2>
                    <div class="chart-container">
                        <canvas id="yearChart"></canvas>
                    </div>
                </div>

                <div id="groupTab" class="tab-content">
                    <h2>Group Rankings by Average Character Rank</h2>
                    <table id="groupRankingsTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Group</th>
                                <th>Avg. Character Rank</th>
                                <th>Characters</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="bloodTab" class="tab-content">
                    <h2>Blood Type Statistics</h2>
                    <div class="chart-container">
                        <canvas id="bloodChart"></canvas>
                    </div>
                </div>

                <div id="heightTab" class="tab-content">
                    <h2>Height Analysis</h2>
                    <div id="heightStats"></div>
                    <!-- New chart container for the improved visualization -->
                    <div
                        id="heightChartContainer"
                        class="height-bar-container scroll-container"
                    ></div>
                </div>
            </div>
        </div>

        <!-- Export/Import Modal -->
        <div class="export-import-modal" id="exportImportModal">
            <div class="export-import-content">
                <h3 id="modalTitle">Export Results</h3>
                <textarea
                    id="exportImportTextarea"
                    class="export-import-textarea"
                    placeholder="Export/Import data will appear here..."
                ></textarea>
                <div class="export-import-buttons">
                    <button class="copy-btn" id="copyBtn">
                        Copy to Clipboard
                    </button>
                    <button
                        class="import-confirm-btn"
                        id="importConfirmBtn"
                        style="display: none"
                    >
                        Import
                    </button>
                    <button class="close-btn" id="closeModalBtn">Close</button>
                </div>
            </div>
        </div>

        <div class="creator-credit">
            Created by
            <a href="https://github.com/Yuberz" target="_blank">Yuberz</a>
        </div>

        <script>
            // Chart instances for destruction
            let yearChartInstance = null;
            let bloodChartInstance = null;

            // Character data with blood type and height
            const CHARACTER_DATA = [
                // Î¼'s characters
                {
                    name: "Honoka Kosaka",
                    year: 2,
                    group: "Î¼'s",
                    blood_type: "O",
                    height: 157,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/e/e9/Main_Page_Honoka.png",
                },
                {
                    name: "Kotori Minami",
                    year: 2,
                    group: "Î¼'s",
                    blood_type: "O",
                    height: 159,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/0/02/Main_Page_Kotori.png",
                },
                {
                    name: "Umi Sonoda",
                    year: 2,
                    group: "Î¼'s",
                    blood_type: "A",
                    height: 159,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/5/5d/Main_Page_Umi.png",
                },
                {
                    name: "Hanayo Koizumi",
                    year: 1,
                    group: "Î¼'s",
                    blood_type: "A",
                    height: 156,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/2/27/Main_Page_Hanayo.png",
                },
                {
                    name: "Rin Hoshizora",
                    year: 1,
                    group: "Î¼'s",
                    blood_type: "AB",
                    height: 155,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/6/69/Main_Page_Rin.png",
                },
                {
                    name: "Maki Nishikino",
                    year: 1,
                    group: "Î¼'s",
                    blood_type: "A",
                    height: 161,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/3/3e/Main_Page_Maki.png",
                },
                {
                    name: "Nico Yazawa",
                    year: 3,
                    group: "Î¼'s",
                    blood_type: "A",
                    height: 154,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/5/5f/Main_Page_Nico.png",
                },
                {
                    name: "Eli Ayase",
                    year: 3,
                    group: "Î¼'s",
                    blood_type: "B",
                    height: 162,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/1/1b/Main_Page_Eli.png",
                },
                {
                    name: "Nozomi Tojo",
                    year: 3,
                    group: "Î¼'s",
                    blood_type: "O",
                    height: 159,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/a/ab/Main_Page_Nozomi.png",
                },

                // Aqours characters
                {
                    name: "Chika Takami",
                    year: 2,
                    group: "Aqours",
                    blood_type: "B",
                    height: 157,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/b/bc/Main_Page_Chika.png",
                },
                {
                    name: "Riko Sakurauchi",
                    year: 2,
                    group: "Aqours",
                    blood_type: "A",
                    height: 160,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/c/c4/Main_Page_Riko.png",
                },
                {
                    name: "Kanan Matsuura",
                    year: 3,
                    group: "Aqours",
                    blood_type: "O",
                    height: 162,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/8a/Main_Page_Kanan.png",
                },
                {
                    name: "Dia Kurosawa",
                    year: 3,
                    group: "Aqours",
                    blood_type: "A",
                    height: 162,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/c/cb/Main_Page_Dia.png",
                },
                {
                    name: "You Watanabe",
                    year: 2,
                    group: "Aqours",
                    blood_type: "AB",
                    height: 157,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/84/Main_Page_You.png",
                },
                {
                    name: "Yoshiko Tsushima",
                    year: 1,
                    group: "Aqours",
                    blood_type: "O",
                    height: 156,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/c/c7/Main_Page_Yoshiko.png",
                },
                {
                    name: "Hanamaru Kunikida",
                    year: 1,
                    group: "Aqours",
                    blood_type: "O",
                    height: 152,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/85/Main_Page_Hanamaru.png",
                },
                {
                    name: "Mari Ohara",
                    year: 3,
                    group: "Aqours",
                    blood_type: "AB",
                    height: 163,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/a/a0/Main_Page_Mari.png",
                },
                {
                    name: "Ruby Kurosawa",
                    year: 1,
                    group: "Aqours",
                    blood_type: "A",
                    height: 157,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/4/46/Main_Page_Ruby.png",
                },

                // Nijigaku characters
                {
                    name: "Yu Takasaki",
                    year: 2,
                    group: "Nijigaku",
                    blood_type: "-",
                    height: 156,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/5/5a/Main_Page_Yu.png",
                },
                {
                    name: "Ayumu Uehara",
                    year: 2,
                    group: "Nijigaku",
                    blood_type: "A",
                    height: 159,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/8a/Main_Page_Ayumu.png",
                },
                {
                    name: "Kasumi Nakasu",
                    year: 1,
                    group: "Nijigaku",
                    blood_type: "B",
                    height: 155,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/b/ba/Main_Page_Kasumi.png",
                },
                {
                    name: "Shizuku Osaka",
                    year: 1,
                    group: "Nijigaku",
                    blood_type: "A",
                    height: 157,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/b/b8/Main_Page_Shizuku.png",
                },
                {
                    name: "Karin Asaka",
                    year: 3,
                    group: "Nijigaku",
                    blood_type: "AB",
                    height: 167,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/7/71/Main_Page_Karin.png",
                },
                {
                    name: "Ai Miyashita",
                    year: 2,
                    group: "Nijigaku",
                    blood_type: "A",
                    height: 163,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/b/b4/Main_Page_Ai.png",
                },
                {
                    name: "Kanata Konoe",
                    year: 3,
                    group: "Nijigaku",
                    blood_type: "O",
                    height: 158,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/9/99/Main_Page_Kanata.png",
                },
                {
                    name: "Setsuna Yuki",
                    year: 2,
                    group: "Nijigaku",
                    blood_type: "O",
                    height: 154,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/7/76/Main_Page_Setsuna.png",
                },
                {
                    name: "Emma Verde",
                    year: 3,
                    group: "Nijigaku",
                    blood_type: "O",
                    height: 166,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/82/Main_Page_Emma.png",
                },
                {
                    name: "Rina Tennoji",
                    year: 1,
                    group: "Nijigaku",
                    blood_type: "B",
                    height: 149,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/c/cf/Main_Page_Rina.png",
                },
                {
                    name: "Shioriko Mifune",
                    year: 1,
                    group: "Nijigaku",
                    blood_type: "AB",
                    height: 160,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/0/07/Main_Page_Shioriko.png",
                },
                {
                    name: "Mia Taylor",
                    year: 3,
                    group: "Nijigaku",
                    blood_type: "AB",
                    height: 156,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/1/13/Main_Page_Mia.png",
                },
                {
                    name: "Lanzhu Zhong",
                    year: 2,
                    group: "Nijigaku",
                    blood_type: "B",
                    height: 165,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/d/d3/Main_Page_Lanzhu.png",
                },

                // Liella! characters
                {
                    name: "Kanon Shibuya",
                    year: 3,
                    group: "Liella!",
                    blood_type: "A",
                    height: 159,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/d/d2/Main_Page_Kanon.png",
                },
                {
                    name: "Keke Tang",
                    year: 3,
                    group: "Liella!",
                    blood_type: "O",
                    height: 159,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/5/50/Main_Page_Keke.png",
                },
                {
                    name: "Chisato Arashi",
                    year: 3,
                    group: "Liella!",
                    blood_type: "B",
                    height: 155,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/f/f5/Main_Page_Chisato.png",
                },
                {
                    name: "Sumire Heanna",
                    year: 3,
                    group: "Liella!",
                    blood_type: "AB",
                    height: 161,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/6/65/Main_Page_Sumire.png",
                },
                {
                    name: "Ren Hazuki",
                    year: 3,
                    group: "Liella!",
                    blood_type: "A",
                    height: 163,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/b/b3/Main_Page_Ren.png",
                },
                {
                    name: "Kinako Sakurakoji",
                    year: 2,
                    group: "Liella!",
                    blood_type: "O",
                    height: 159,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/2/28/Main_Page_Kinako.png",
                },
                {
                    name: "Mei Yoneme",
                    year: 2,
                    group: "Liella!",
                    blood_type: "A",
                    height: 155,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/6/6c/Main_Page_Mei.png",
                },
                {
                    name: "Shiki Wakana",
                    year: 2,
                    group: "Liella!",
                    blood_type: "B",
                    height: 161,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/2/2f/Main_Page_Shiki.png",
                },
                {
                    name: "Natsumi Onitsuka",
                    year: 2,
                    group: "Liella!",
                    blood_type: "AB",
                    height: 152,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/9/9a/Main_Page_Natsumi.png",
                },
                {
                    name: "Wien Margarete",
                    year: 1,
                    group: "Liella!",
                    blood_type: "A",
                    height: 161,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/81/Main_Page_Wien.png",
                },
                {
                    name: "Tomari Onitsuka",
                    year: 1,
                    group: "Liella!",
                    blood_type: "B",
                    height: 163,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/c/c0/Main_Page_Tomari.png",
                },

                // Hasunosora characters
                {
                    name: "Kaho Hinoshita",
                    year: 3,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 155,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/2/23/Main_Page_Kaho.png",
                },
                {
                    name: "Sayaka Murano",
                    year: 3,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 157,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/6/69/Main_Page_Sayaka.png",
                },
                {
                    name: "Kozue Otomune",
                    year: 4,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 167,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/4/44/Main_Page_Kozue.png",
                },
                {
                    name: "Tsuzuri Yugiri",
                    year: 4,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 171,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/6/63/Main_Page_Tsuzuri.png",
                },
                {
                    name: "Rurino Osawa",
                    year: 3,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 151,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/2/22/Main_Page_Rurino.png",
                },
                {
                    name: "Megumi Fujishima",
                    year: 4,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 160,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/5/54/Main_Page_Megumi.png",
                },
                {
                    name: "Ginko Momose",
                    year: 2,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 162,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/80/Main_Page_Ginko.png",
                },
                {
                    name: "Kosuzu Kachimachi",
                    year: 2,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 152,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/8/8e/Main_Page_Kosuzu.png",
                },
                {
                    name: "Hime Anyoji",
                    year: 2,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 160,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/c/c6/Main_Page_Hime.png",
                },
                {
                    name: "Ceras Yanagida Lilienfeld",
                    year: 1,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 153,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/5/5a/Main_Page_Ceras.png",
                },
                {
                    name: "Izumi Katsuragi",
                    year: 2,
                    group: "Hasunosora",
                    blood_type: "-",
                    height: 170,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/0/07/Main_Page_Izumi.png",
                },

                // Ikizurai-Bu! characters
                {
                    name: "Polka Takahashi",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "-",
                    height: 157,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/2/2e/Main_Page_Polka.png",
                },
                {
                    name: "Mai Azabu",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "B",
                    height: 154,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/c/cf/Main_Page_Mai.png",
                },
                {
                    name: "Akira Goto",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "O",
                    height: 164,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/1/19/Main_Page_Akira.png",
                },
                {
                    name: "Hanabi Komagata",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "A",
                    height: 160,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/b/ba/Main_Page_Hanabi.png",
                },
                {
                    name: "Miracle Kanazawa",
                    year: 2,
                    group: "Ikizurai-Bu!",
                    blood_type: "AB",
                    height: 152,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/b/bf/Main_Page_Miracle.png",
                },
                {
                    name: "Noriko Chofu",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "B",
                    height: 153,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/0/0a/Main_Page_Noriko.png",
                },
                {
                    name: "Yukuri Harumiya",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "B",
                    height: 165,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/e/ef/Main_Page_Yukuri.png",
                },
                {
                    name: "Aurora Konohana",
                    year: 2,
                    group: "Ikizurai-Bu!",
                    blood_type: "O",
                    height: 162,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/2/29/Main_Page_Aurora.png",
                },
                {
                    name: "Midori Yamada",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "A",
                    height: 155,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/d/d7/Main_Page_Midori.png",
                },
                {
                    name: "Shion Sasaki",
                    year: 1,
                    group: "Ikizurai-Bu!",
                    blood_type: "-",
                    height: 158,
                    image_url:
                        "https://static.wikia.nocookie.net/love-live/images/e/e0/Main_Page_Shion.png",
                },
            ];

            // Tournament state
            let tournament = {
                characters: [],
                wins: {},
                matchups: [],
                currentMatchup: 0,
                comparisonsDone: 0,
                skippedComparisons: 0,
                totalPossibleMatchups: 0,
                graph: {},
                quickMode: false,
                selectedGroups: [],
                history: [], // Added for undo functionality
                showGroupYear: false,
                showBloodHeight: false,
            };

            // DOM Elements
            const groupContainer = document.getElementById("groupContainer");
            const matchupContainer =
                document.getElementById("matchupContainer");
            const progressText = document.getElementById("progressText");
            const resultsBtn = document.getElementById("resultsBtn");
            const mainContainer = document.querySelector(".main-container");
            const resultsContainer =
                document.getElementById("resultsContainer");
            const backBtn = document.getElementById("backBtn");
            const selectAllBtn = document.getElementById("selectAllBtn");
            const selectNoneBtn = document.getElementById("selectNoneBtn");
            const quickModeCheckbox = document.getElementById("quickMode");
            const tabButtons = document.querySelectorAll(".tab-btn");
            const tabContents = document.querySelectorAll(".tab-content");
            const completedMatchupsEl =
                document.getElementById("completedMatchups");
            const skippedMatchupsEl =
                document.getElementById("skippedMatchups");
            const skippedContainer =
                document.getElementById("skippedContainer");
            const undoBtn = document.getElementById("undoBtn");
            const showGroupYearCheckbox =
                document.getElementById("showGroupYear");
            const showBloodHeightCheckbox =
                document.getElementById("showBloodHeight");

            // Export/Import Elements
            const exportBtn = document.getElementById("exportBtn");
            const importBtn = document.getElementById("importBtn");
            const importMainBtn = document.getElementById("importMainBtn");
            const exportImportModal =
                document.getElementById("exportImportModal");
            const modalTitle = document.getElementById("modalTitle");
            const exportImportTextarea = document.getElementById(
                "exportImportTextarea",
            );
            const copyBtn = document.getElementById("copyBtn");
            const closeModalBtn = document.getElementById("closeModalBtn");

            // Initialize the application
            function initApp() {
                // Extract unique groups
                const groups = [
                    ...new Set(CHARACTER_DATA.map((char) => char.group)),
                ];

                // Create group checkboxes
                groups.forEach((group) => {
                    const groupItem = document.createElement("div");
                    groupItem.className = "group-item";
                    groupItem.innerHTML = `
                    <input type="checkbox" id="${group}" class="group-checkbox" checked>
                    <label for="${group}">${group}</label>
                `;
                    groupContainer.appendChild(groupItem);
                });

                // Reset all UI elements to default state
                quickModeCheckbox.checked = false;
                showGroupYearCheckbox.checked = false;
                showBloodHeightCheckbox.checked = false;
                tournament.quickMode = false;
                tournament.showGroupYear = false;
                tournament.showBloodHeight = false;
                resultsBtn.disabled = true;
                undoBtn.disabled = true;

                // Set initial groups
                tournament.selectedGroups = groups;
                updateCharacterSelection();

                // Event listeners
                document
                    .querySelectorAll(".group-checkbox")
                    .forEach((checkbox) => {
                        checkbox.addEventListener(
                            "change",
                            updateCharacterSelection,
                        );
                    });

                selectAllBtn.addEventListener("click", () => {
                    document
                        .querySelectorAll(".group-checkbox")
                        .forEach((checkbox) => {
                            checkbox.checked = true;
                        });
                    updateCharacterSelection();
                });

                selectNoneBtn.addEventListener("click", () => {
                    document
                        .querySelectorAll(".group-checkbox")
                        .forEach((checkbox) => {
                            checkbox.checked = false;
                        });
                    updateCharacterSelection();
                });

                resultsBtn.addEventListener("click", showResults);

                // Updated back button event listener
                backBtn.addEventListener("click", () => {
                    // Destroy all charts
                    if (yearChartInstance) {
                        yearChartInstance.destroy();
                        yearChartInstance = null;
                    }
                    if (bloodChartInstance) {
                        bloodChartInstance.destroy();
                        bloodChartInstance = null;
                    }

                    resultsContainer.style.display = "none";
                    mainContainer.style.display = "block";
                    // Reset tournament with current settings
                    resetTournament();
                });

                quickModeCheckbox.addEventListener("change", () => {
                    tournament.quickMode = quickModeCheckbox.checked;
                    resetTournament();
                });

                showGroupYearCheckbox.addEventListener("change", () => {
                    tournament.showGroupYear = showGroupYearCheckbox.checked;
                    redrawMatchup();
                });

                showBloodHeightCheckbox.addEventListener("change", () => {
                    tournament.showBloodHeight =
                        showBloodHeightCheckbox.checked;
                    redrawMatchup();
                });

                // Tab switching
                tabButtons.forEach((button) => {
                    button.addEventListener("click", () => {
                        const tabId = button.getAttribute("data-tab");

                        // Update button states
                        tabButtons.forEach((btn) =>
                            btn.classList.remove("active"),
                        );
                        button.classList.add("active");

                        // Update tab content
                        tabContents.forEach((content) => {
                            content.classList.remove("active");
                            if (content.id === `${tabId}Tab`) {
                                content.classList.add("active");
                            }
                        });
                    });
                });

                // Undo button event listener
                undoBtn.addEventListener("click", undoLastChoice);

                // Export/Import event listeners
                exportBtn.addEventListener("click", showExportModal);
                importBtn.addEventListener("click", () =>
                    showImportModal(false),
                );
                importConfirmBtn.addEventListener("click", confirmImport);
                importMainBtn.addEventListener("click", () =>
                    showImportModal(true),
                );
                copyBtn.addEventListener("click", copyToClipboard);
                closeModalBtn.addEventListener("click", closeModal);
            }

            // Update character selection based on groups
            function updateCharacterSelection() {
                const selectedGroups = [];
                document
                    .querySelectorAll(".group-checkbox:checked")
                    .forEach((checkbox) => {
                        selectedGroups.push(checkbox.id);
                    });

                tournament.selectedGroups = selectedGroups;
                tournament.characters = CHARACTER_DATA.filter((char) =>
                    selectedGroups.includes(char.group),
                );

                // Reset tournament with new selection
                resetTournament();
            }

            // Reset tournament state
            function resetTournament() {
                tournament.wins = {};
                tournament.matchups = [];
                tournament.currentMatchup = 0;
                tournament.comparisonsDone = 0;
                tournament.skippedComparisons = 0;
                tournament.graph = {};
                tournament.history = [];

                // Initialize wins and graph
                tournament.characters.forEach((char) => {
                    tournament.wins[char.name] = 0;
                    tournament.graph[char.name] = new Set();
                });

                // Create matchups
                const names = tournament.characters.map((char) => char.name);
                for (let i = 0; i < names.length; i++) {
                    for (let j = i + 1; j < names.length; j++) {
                        tournament.matchups.push([names[i], names[j]]);
                    }
                }

                // Shuffle matchups
                shuffleArray(tournament.matchups);
                tournament.totalPossibleMatchups = tournament.matchups.length;

                // Update UI
                updateProgressText();
                resultsBtn.disabled = true;
                undoBtn.disabled = true;

                // Show first matchup
                showMatchup();
            }

            // Shuffle array
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Show current matchup
            function showMatchup() {
                matchupContainer.innerHTML = "";
                undoBtn.disabled = tournament.history.length === 0;

                if (tournament.characters.length < 2) {
                    progressText.textContent =
                        "Select at least 1 group to sort!";
                    return;
                }

                // Update skipped container visibility
                if (tournament.quickMode) {
                    skippedContainer.style.display = "block";
                } else {
                    skippedContainer.style.display = "none";
                }

                // Skip known relationships in quick mode
                if (tournament.quickMode) {
                    while (
                        tournament.currentMatchup < tournament.matchups.length
                    ) {
                        const [char1, char2] =
                            tournament.matchups[tournament.currentMatchup];

                        if (isKnownRelationship(char1, char2)) {
                            // FIX: Award win to transitive winner
                            let winner;
                            if (tournament.graph[char1].has(char2)) {
                                winner = char1;
                            } else if (tournament.graph[char2].has(char1)) {
                                winner = char2;
                            } else {
                                // Shouldn't happen, but skip if it does
                                console.error(
                                    "Inconsistent graph for",
                                    char1,
                                    char2,
                                );
                                tournament.skippedComparisons++;
                                tournament.currentMatchup++;
                                continue;
                            }

                            // Award win to transitive winner
                            tournament.wins[winner]++;
                            tournament.skippedComparisons++;
                            tournament.currentMatchup++;
                            updateProgressText();
                        } else {
                            break;
                        }
                    }
                }

                // Check if tournament is complete
                if (tournament.currentMatchup >= tournament.matchups.length) {
                    if (tournament.matchups.length > 0) {
                        resultsBtn.disabled = false;

                        // Update progress text for completion
                        if (tournament.quickMode) {
                            const progressPercent =
                                ((tournament.comparisonsDone +
                                    tournament.skippedComparisons) /
                                    tournament.totalPossibleMatchups) *
                                100;
                            progressText.textContent = `Sorting Complete!`;
                        } else {
                            progressText.textContent =
                                "Sorting Complete! Click 'View Results' to see rankings.";
                        }
                    }
                    return;
                }

                // Redraw the matchup
                redrawMatchup();
            }

            // Redraw the current matchup
            function redrawMatchup() {
                matchupContainer.innerHTML = "";

                // Get current matchup characters
                const [char1Name, char2Name] =
                    tournament.matchups[tournament.currentMatchup];
                const char1 = tournament.characters.find(
                    (c) => c.name === char1Name,
                );
                const char2 = tournament.characters.find(
                    (c) => c.name === char2Name,
                );

                // Create matchup buttons
                const char1Btn = createCharacterButton(char1, 0);
                const char2Btn = createCharacterButton(char2, 1);

                matchupContainer.appendChild(char1Btn);
                matchupContainer.appendChild(char2Btn);
            }

            // Create character button
            function createCharacterButton(char, index) {
                const button = document.createElement("div");
                button.className = "character-btn";

                let infoHTML = "";

                // Add group and year info if enabled
                if (tournament.showGroupYear) {
                    infoHTML += `<div class="character-info">${char.group} â€¢ Year ${char.year}</div>`;
                }

                // Add blood type and height info if enabled
                if (tournament.showBloodHeight) {
                    const bloodType =
                        char.blood_type === "-" ? "Unknown" : char.blood_type;
                    infoHTML += `<div class="character-info">Blood: ${bloodType} â€¢ Height: ${char.height} cm</div>`;
                }

                button.innerHTML = `
                <img src="${char.image_url}" alt="${char.name}" class="character-img" onerror="this.src='https://via.placeholder.com/220x220/ffccdd/666666?text=Image+Not+Available'">
                <div class="character-name">${char.name}</div>
                ${infoHTML}
            `;

                button.addEventListener("click", () => {
                    recordChoice(index);
                });

                return button;
            }

            // Record user choice
            function recordChoice(choiceIndex) {
                const [char1Name, char2Name] =
                    tournament.matchups[tournament.currentMatchup];
                const winner = choiceIndex === 0 ? char1Name : char2Name;
                const loser = choiceIndex === 0 ? char2Name : char1Name;

                // Save state to history for undo
                tournament.history.push({
                    matchup: [char1Name, char2Name],
                    winner: winner,
                    wins: { ...tournament.wins },
                    graph: tournament.quickMode
                        ? cloneGraph(tournament.graph)
                        : null,
                    comparisonsDone: tournament.comparisonsDone,
                    skippedComparisons: tournament.skippedComparisons,
                    currentMatchup: tournament.currentMatchup,
                });

                // Update wins
                tournament.wins[winner]++;
                tournament.comparisonsDone++;

                // Update graph in quick mode
                if (tournament.quickMode) {
                    updateGraph(winner, loser);
                }

                // Move to next matchup
                tournament.currentMatchup++;
                updateProgressText();
                showMatchup();
            }

            // Clone graph for undo functionality
            function cloneGraph(graph) {
                const clone = {};
                for (const char in graph) {
                    clone[char] = new Set(graph[char]);
                }
                return clone;
            }

            // Undo last choice
            function undoLastChoice() {
                if (tournament.history.length === 0) return;

                const lastAction = tournament.history.pop();

                // Restore state
                tournament.wins = lastAction.wins;
                tournament.comparisonsDone = lastAction.comparisonsDone;
                tournament.skippedComparisons = lastAction.skippedComparisons;
                tournament.currentMatchup = lastAction.currentMatchup;

                if (tournament.quickMode && lastAction.graph) {
                    tournament.graph = lastAction.graph;
                }

                // Update UI
                updateProgressText();
                showMatchup();
            }

            // Check if relationship is known
            function isKnownRelationship(char1, char2) {
                // Check if both characters are in the graph
                if (
                    !(char1 in tournament.graph) ||
                    !(char2 in tournament.graph)
                ) {
                    return false;
                }

                return (
                    tournament.graph[char1].has(char2) ||
                    tournament.graph[char2].has(char1)
                );
            }

            // Update propagation graph (FIXED)
            function updateGraph(winner, loser) {
                // Add direct relationship
                tournament.graph[winner].add(loser);

                // Winner is better than everyone loser is better than
                tournament.graph[loser].forEach((char) => {
                    tournament.graph[winner].add(char);
                });

                // Find all characters that are better than winner
                Object.keys(tournament.graph).forEach((char) => {
                    if (tournament.graph[char].has(winner)) {
                        // Add loser to characters that are better than winner
                        tournament.graph[char].add(loser);

                        // Add everyone loser is better than to characters that are better than winner
                        tournament.graph[loser].forEach((subChar) => {
                            tournament.graph[char].add(subChar);
                        });
                    }
                });
            }

            // Update progress text
            function updateProgressText() {
                completedMatchupsEl.textContent = tournament.comparisonsDone;
                skippedMatchupsEl.textContent = tournament.skippedComparisons;

                if (tournament.quickMode) {
                    if (tournament.totalPossibleMatchups > 0) {
                        const progressPercent =
                            ((tournament.comparisonsDone +
                                tournament.skippedComparisons) /
                                tournament.totalPossibleMatchups) *
                            100;
                        progressText.textContent = `Progress: ${progressPercent.toFixed(1)}%`;
                    } else {
                        progressText.textContent =
                            "Select at least 1 group to sort!";
                    }
                } else {
                    if (tournament.matchups.length > 0) {
                        progressText.textContent = `Matchup ${tournament.currentMatchup + 1} of ${tournament.matchups.length}`;
                    } else {
                        progressText.textContent =
                            "Select at least 1 group to sort!";
                    }
                }
            }

            // Show results
            function showResults() {
                mainContainer.style.display = "none";
                resultsContainer.style.display = "block";

                // Show rankings
                showRankings();

                // Show year statistics
                showYearStats();

                // Show group statistics
                showGroupStats();

                // Show blood type statistics
                showBloodStats();

                // Show height analysis
                showHeightAnalysis();
            }

            // Show character rankings
            function showRankings() {
                const tableBody = document.querySelector(
                    "#rankingsTable tbody",
                );
                tableBody.innerHTML = "";

                // Sort characters by wins
                const sortedCharacters = [...tournament.characters].sort(
                    (a, b) => tournament.wins[b.name] - tournament.wins[a.name],
                );

                // Populate table
                sortedCharacters.forEach((char, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${char.name}</td>
                    <td>${tournament.wins[char.name]}</td>
                    <td>${char.year}</td>
                    <td>${char.group}</td>
                `;
                    tableBody.appendChild(row);
                });
            }

            // Show year statistics
            function showYearStats() {
                // Destroy existing chart if it exists
                if (yearChartInstance) {
                    yearChartInstance.destroy();
                }

                const yearWins = {};

                // Calculate wins by year
                tournament.characters.forEach((char) => {
                    const year = char.year;
                    if (!yearWins[year]) {
                        yearWins[year] = 0;
                    }
                    yearWins[year] += tournament.wins[char.name];
                });

                // Prepare chart data
                const years = Object.keys(yearWins).sort();
                const wins = years.map((year) => yearWins[year]);

                // Create chart
                const ctx = document
                    .getElementById("yearChart")
                    .getContext("2d");
                yearChartInstance = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: years.map((year) => `Year ${year}`),
                        datasets: [
                            {
                                label: "Wins by Year",
                                data: wins,
                                backgroundColor: "#ff99cc",
                                borderColor: "#ff66aa",
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Wins",
                                },
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: "School Year",
                                },
                            },
                        },
                    },
                });
            }

            // Show group statistics (UPDATED to show average ranking)
            function showGroupStats() {
                const tableBody = document.querySelector(
                    "#groupRankingsTable tbody",
                );
                tableBody.innerHTML = "";

                // First, get character rankings
                const sortedCharacters = [...tournament.characters].sort(
                    (a, b) => tournament.wins[b.name] - tournament.wins[a.name],
                );

                // Create a map of character name to rank
                const characterRanks = {};
                sortedCharacters.forEach((char, index) => {
                    characterRanks[char.name] = index + 1;
                });

                // Calculate average rank for each group
                const groupRanks = {};

                tournament.characters.forEach((char) => {
                    const group = char.group;
                    if (!groupRanks[group]) {
                        groupRanks[group] = {
                            totalRank: 0,
                            count: 0,
                            characters: [],
                        };
                    }
                    groupRanks[group].totalRank += characterRanks[char.name];
                    groupRanks[group].count += 1;
                    groupRanks[group].characters.push(char.name);
                });

                // Calculate average and prepare for sorting
                const groupAverages = [];
                for (const group in groupRanks) {
                    const avg =
                        groupRanks[group].totalRank / groupRanks[group].count;
                    groupAverages.push({
                        group: group,
                        average: avg,
                        characters: groupRanks[group].characters,
                    });
                }

                // Sort groups by average rank (lowest average = best)
                groupAverages.sort((a, b) => a.average - b.average);

                // Populate the table
                groupAverages.forEach((group, index) => {
                    const row = document.createElement("tr");

                    // Format character list
                    const characterList = group.characters
                        .map((name) => {
                            const rank = characterRanks[name];
                            return `${name} (#${rank})`;
                        })
                        .join(", ");

                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${group.group}</td>
                        <td>${group.average.toFixed(2)}</td>
                        <td>${characterList}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Show blood type statistics
            function showBloodStats() {
                // Destroy existing chart if it exists
                if (bloodChartInstance) {
                    bloodChartInstance.destroy();
                }

                const bloodWins = {};

                // Calculate wins by blood type
                tournament.characters.forEach((char) => {
                    const bt = char.blood_type;
                    if (bt !== "-") {
                        if (!bloodWins[bt]) {
                            bloodWins[bt] = 0;
                        }
                        bloodWins[bt] += tournament.wins[char.name];
                    }
                });

                // Prepare chart data
                const bloodTypes = Object.keys(bloodWins);
                const wins = bloodTypes.map((bt) => bloodWins[bt]);
                const backgroundColors = bloodTypes.map((_, i) => {
                    const colors = ["#ff9999", "#66b3ff", "#99ff99", "#ffcc99"];
                    return colors[i % colors.length];
                });

                // Create chart
                const ctx = document
                    .getElementById("bloodChart")
                    .getContext("2d");
                bloodChartInstance = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: bloodTypes.map((bt) => `Type ${bt}`),
                        datasets: [
                            {
                                label: "Wins by Blood Type",
                                data: wins,
                                backgroundColor: backgroundColors,
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "right",
                            },
                        },
                    },
                });
            }

            // Show height analysis (IMPROVED)
            function showHeightAnalysis() {
                const heightStats = document.getElementById("heightStats");
                const heightChartContainer = document.getElementById(
                    "heightChartContainer",
                );

                // Clear previous content
                heightStats.innerHTML = "";
                heightChartContainer.innerHTML = "";

                const validHeightChars = tournament.characters.filter(
                    (char) => char.height > 0,
                );

                if (validHeightChars.length === 0) {
                    heightStats.textContent =
                        "No valid height data available for selected characters";
                    return;
                }

                // Calculate height statistics
                const overallAvg =
                    validHeightChars.reduce(
                        (sum, char) => sum + char.height,
                        0,
                    ) / validHeightChars.length;

                let userTotal = 0;
                let userCount = 0;
                validHeightChars.forEach((char) => {
                    const wins = tournament.wins[char.name];
                    userTotal += char.height * wins;
                    userCount += wins;
                });

                const userAvg = userCount > 0 ? userTotal / userCount : 0;

                // Determine preference
                const diff = userAvg - overallAvg;
                let preference, preferenceIcon;
                if (Math.abs(diff) < 0.5) {
                    preference = "You have no significant height preference.";
                    preferenceIcon = "=";
                } else if (diff > 0) {
                    preference =
                        "Your preferences lean toward taller characters.";
                    preferenceIcon = "â†‘";
                } else {
                    preference =
                        "Your preferences lean toward shorter characters.";
                    preferenceIcon = "â†“";
                }

                // Create stats summary
                const summaryHTML = `
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-label">Overall Average Height</div>
                            <div class="stat-value">${overallAvg.toFixed(1)}</div>
                            <div class="stat-label">cm</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Your Preferred Height</div>
                            <div class="stat-value">${userAvg.toFixed(1)}</div>
                            <div class="stat-label">cm</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Preference</div>
                            <div class="preference-indicator">
                                <span class="preference-icon">${preferenceIcon}</span>
                                <span>${diff > 0 ? "Taller" : diff < 0 ? "Shorter" : "Neutral"}</span>
                            </div>
                            <div class="stat-label">${preference}</div>
                        </div>
                    </div>
                `;

                heightStats.innerHTML = summaryHTML;

                // Sort characters by height descending
                const sortedByHeight = [...validHeightChars].sort(
                    (a, b) => b.height - a.height,
                );

                // Find max wins for scaling
                const maxWins = Math.max(
                    ...sortedByHeight.map((char) => tournament.wins[char.name]),
                    1,
                );

                // Create a bar for each character
                sortedByHeight.forEach((char) => {
                    const wins = tournament.wins[char.name];
                    const winPercentage = Math.max(5, (wins / maxWins) * 95);

                    const barHTML = `
                        <div class="height-bar">
                            <div class="character-info-container">
                                <img src="${char.image_url}" alt="${char.name}"
                                     class="character-thumb"
                                     onerror="this.src='https://via.placeholder.com/60x60/ffccdd/666666?text=Image'">
                                <div class="character-name-info">
                                    <div class="character-name-bar">${char.name}</div>
                                    <div class="character-details">
                                        ${char.group} â€¢ Year ${char.year}
                                    </div>
                                </div>
                            </div>

                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${winPercentage}%">
                                    <span class="bar-value">${wins} win${wins !== 1 ? "s" : ""}</span>
                                </div>
                            </div>

                            <div class="height-info">
                                <div class="height-label">${char.height} cm</div>
                                <div class="height-cm">Height</div>
                            </div>
                        </div>
                    `;

                    heightChartContainer.innerHTML += barHTML;
                });
            }

            // Export results function
            function exportResults() {
                // Create export data object
                const exportData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    wins: tournament.wins,
                    selectedGroups: tournament.selectedGroups,
                    comparisonsDone: tournament.comparisonsDone,
                    skippedComparisons: tournament.skippedComparisons,
                };

                // Convert to JSON string and then base64 encode
                const jsonString = JSON.stringify(exportData);
                const base64String = btoa(
                    unescape(encodeURIComponent(jsonString)),
                );

                // Show modal with export data
                modalTitle.textContent = "Export Results";
                exportImportTextarea.value = base64String;
                exportImportModal.style.display = "flex";
            }

            // Show import modal
            function showImportModal(isFromMain) {
                modalTitle.textContent = "Import Results";
                exportImportTextarea.value = "";

                // Show/hide appropriate buttons
                copyBtn.style.display = "none";
                importConfirmBtn.style.display = "block";
                closeModalBtn.textContent = "Cancel";

                exportImportModal.style.display = "flex";

                // Store where import was initiated from
                exportImportModal.dataset.fromMain = isFromMain;
            }

            function showExportModal() {
                modalTitle.textContent = "Export Results";

                // Create export data
                const exportData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    wins: tournament.wins,
                    selectedGroups: tournament.selectedGroups,
                    comparisonsDone: tournament.comparisonsDone,
                    skippedComparisons: tournament.skippedComparisons,
                };

                // Convert to JSON string and then base64 encode
                const jsonString = JSON.stringify(exportData);
                const base64String = btoa(
                    unescape(encodeURIComponent(jsonString)),
                );
                exportImportTextarea.value = base64String;

                // Show/hide appropriate buttons
                copyBtn.style.display = "block";
                importConfirmBtn.style.display = "none";
                closeModalBtn.textContent = "Close";

                exportImportModal.style.display = "flex";
            }

            // Copy to clipboard function
            function copyToClipboard() {
                exportImportTextarea.select();
                document.execCommand("copy");

                // Show notification
                showNotification("Copied to clipboard!");
            }

            // Close modal function
            function closeModal() {
                exportImportModal.style.display = "none";
            }

            function confirmImport() {
                const importString = exportImportTextarea.value.trim();
                if (importString !== "") {
                    processImport(importString);
                }
                closeModal();
            }

            // Process import data
            function processImport(importString) {
                try {
                    // Decode base64 string
                    const jsonString = decodeURIComponent(
                        escape(atob(importString)),
                    );
                    const importData = JSON.parse(jsonString);

                    // Validate import data
                    if (!importData.wins || !importData.selectedGroups) {
                        throw new Error("Invalid import data format");
                    }

                    // Update tournament state with imported data
                    tournament.wins = importData.wins;
                    tournament.selectedGroups = importData.selectedGroups;
                    tournament.comparisonsDone =
                        importData.comparisonsDone || 0;
                    tournament.skippedComparisons =
                        importData.skippedComparisons || 0;

                    // Update group checkboxes
                    document
                        .querySelectorAll(".group-checkbox")
                        .forEach((checkbox) => {
                            checkbox.checked =
                                importData.selectedGroups.includes(checkbox.id);
                        });

                    // Filter characters based on imported groups
                    tournament.characters = CHARACTER_DATA.filter((char) =>
                        importData.selectedGroups.includes(char.group),
                    );

                    // Show notification
                    showNotification("Results imported successfully!");

                    // If import was from main page, show results
                    if (exportImportModal.dataset.fromMain === "true") {
                        showResults();
                    } else {
                        // Refresh results display
                        showRankings();
                        showYearStats();
                        showGroupStats();
                        showBloodStats();
                        showHeightAnalysis();
                    }
                } catch (error) {
                    console.error("Import error:", error);
                    showNotification(
                        "Error importing data. Please check the import string.",
                        true,
                    );
                }
            }

            // Show notification function
            function showNotification(message, isError = false) {
                // Remove existing notifications
                const existingNotifications =
                    document.querySelectorAll(".notification");
                existingNotifications.forEach((notification) =>
                    notification.remove(),
                );

                // Create new notification
                const notification = document.createElement("div");
                notification.className = "notification";
                notification.textContent = message;

                if (isError) {
                    notification.style.background =
                        "linear-gradient(to right, #ff6666, #ff5555)";
                }

                document.body.appendChild(notification);

                // Remove notification after animation
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            // Initialize the application when the page loads
            document.addEventListener("DOMContentLoaded", initApp);
        </script>
    </body>
</html>
